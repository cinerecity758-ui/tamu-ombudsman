<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Form Penerimaan Tamu + Tiket Antrian</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,sans-serif;}
    body{
      background:linear-gradient(135deg,#1e3c72,#2a5298,#ff8c00,#fff);
      background-size:400% 400%;animation:g 15s ease infinite;
      min-height:100vh;padding:15px;
    }
    @keyframes g{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .container{max-width:900px;margin:20px auto;background:rgba(255,255,255,0.96);border-radius:20px;
      box-shadow:0 15px 40px rgba(0,0,0,0.25);overflow:hidden;}
    header{background:linear-gradient(to right,#1e3c72,#2a5298);color:#fff;padding:20px;
      display:flex;align-items:center;gap:20px;text-align:center;}
    .logo{width:80px;height:80px;border-radius:50%;border:5px solid #ff8c00;object-fit:contain;}
    h1{font-size:24px;}
    form{padding:30px;}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
    .full-width{grid-column:1/-1;}
    label{display:block;margin-bottom:8px;font-weight:600;color:#1e3c72;}
    .required{color:red;}
    input,textarea,select{
      width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px;
    }
    input:focus,textarea:focus,select:focus{border-color:#ff8c00;outline:none;}
    .camera-btn{
      background:#007bff;color:#fff;padding:12px 16px;border-radius:8px;margin-top:8px;
      font-size:15px;cursor:pointer;border:none;width:100%;
    }
    .preview{
      width:100%;max-height:300px;object-fit:contain;border-radius:8px;margin-top:10px;
      border:2px dashed #ccc;background:#f9f9f9;display:block;
    }
    #main-submit{
      background:#ff8c00;color:#fff;padding:18px;font-size:20px;font-weight:bold;
      border:none;border-radius:12px;cursor:pointer;width:100%;margin-top:30px;
      transition:0.3s;
    }
    #main-submit:hover{background:#e07b00;}
    #main-submit:disabled{background:#999;cursor:not-allowed;}

    /* Tiket Antrian */
    #tiketAntrian{
      display:none;position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.92);z-index:9999;justify-content:center;align-items:center;
    }
    .tiket-box{
      background:#fff;padding:40px;border-radius:15px;text-align:center;
      box-shadow:0 0 40px rgba(255,152,0,0.9);width:90%;max-width:420px;
    }
    .nomor-besar{font-size:110px;font-weight:bold;color:#ff8c00;margin:15px 0;line-height:1;}
    .btn-print{
      background:#28a745;color:#fff;padding:15px 30px;font-size:18px;border:none;
      border-radius:10px;margin:10px;cursor:pointer;
    }
    .btn-tutup{background:#dc3545;}

    @media (max-width:768px){
      .form-grid{grid-template-columns:1fr;}
      header{flex-direction:column;}
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <img src="Ombudsmanlogo.png" alt="Logo" class="logo"/>
    <h1>FORM PENERIMAAN TAMU</h1>
  </header>

  <form id="tamuForm">
    <div class="form-grid">
      <div><label>Tanggal & Hari</label><input type="text" id="tanggalHari" readonly/></div>
      <div><label>Waktu Kedatangan</label><input type="text" id="waktu" readonly/></div>

      <div><label>Nama Lengkap <span class="required">*</span></label><input type="text" name="nama" required/></div>
      <div><label>Alamat</label><input type="text" name="alamat"/></div>
      <div><label>Instansi / Perusahaan</label><input type="text" name="instansi"/></div>
      <div><label>Bertemu Dengan <span class="required">*</span></label><input type="text" name="menemui" required/></div>
      <div><label>Keperluan / Urusan <span class="required">*</span></label><textarea name="urusan" rows="2" required></textarea></div>

      <div>
        <label>Sudah Janji?</label>
        <select name="janji">
          <option>Sudah</option>
          <option>Belum / Dadakan</option>
        </select>
      </div>

      <!-- FOTO KTP -->
      <div class="full-width">
        <label>Foto KTP <span class="required">*</span></label>
        <button type="button" class="camera-btn" onclick="bukaKamera('ktp')">Ambil Foto KTP</button>
        <input type="file" id="fileKtp" accept="image/*" capture="environment" style="display:none" onchange="previewFoto(this,'previewKtp')"/>
        <img id="previewKtp" class="preview" src="" alt="Preview KTP"/>
        <input type="hidden" name="fotoKtp" id="fotoKtpBase64" required/>
      </div>

      <!-- FOTO DIRI SELURUH BADAN -->
      <div class="full-width">
        <label>Foto Diri (Seluruh Badan) <span class="required">*</span></label>
        <button type="button" class="camera-btn" onclick="bukaKamera('diri')">Foto Seluruh Badan</button>
        <input type="file" id="fileDiri" accept="image/*" capture="environment" style="display:none" onchange="previewFoto(this,'previewDiri')"/>
        <img id="previewDiri" class="preview" src="" alt="Preview Diri"/>
        <input type="hidden" name="fotoDiri" id="fotoDiriBase64" required/>
      </div>

      <!-- FOTO WAJAH CLOSE-UP -->
      <div class="full-width">
        <label>Foto Wajah (Close-up) <span class="required">*</span></label>
        <button type="button" class="camera-btn" onclick="bukaKamera('wajah')">Foto Wajah Depan</button>
        <input type="file" id="fileWajah" accept="image/*" capture="user" style="display:none" onchange="previewFoto(this,'previewWajah')"/>
        <img id="previewWajah" class="preview" src="" alt="Preview Wajah"/>
        <input type="hidden" name="fotoWajah" id="fotoWajahBase64" required/>
      </div>

      <div class="full-width">
        <label>Keterangan Tambahan</label>
        <textarea name="keterangan" rows="3"></textarea>
      </div>
    </div>

    <button type="submit" id="main-submit">SUBMIT & CETAK NOMOR ANTRIAN</button>
  </form>
</div>

<!-- TIKET ANTRIAN -->
<div id="tiketAntrian">
  <div class="tiket-box">
    <h2>TIKET ANTRIAN TAMU</h2>
    <div class="nomor-besar" id="nomorAntrian">001</div>
    <p><strong>Nama:</strong> <span id="tiketNama"></span></p>
    <p><strong>Bertemu:</strong> <span id="tiketMenemui"></span></p>
    <p><strong>Waktu:</strong> <span id="tiketWaktu"></span></p>
    <p><strong>Tanggal:</strong> <span id="tiketTanggal"></span></p>
    <button class="btn-print" onclick="window.print()">CETAK TIKET</button>
    <button class="btn-print btn-tutup" onclick="tutupTiket()">TUTUP</button>
  </div>
</div>

<script>
  // ================== GANTI DENGAN URL WEB APP GOOGLE SCRIPT KAMU SENDIRI ==================
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwscNkMCafNAJ8A-MKbvBaglU3c_tEJBVAAhK7-0UNSsrs-FM3KG7XMtDfrGnxc6Ug/exec";
  // ====================================================================================

  const sekarang = new Date();
  const hari = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
  const hariIni = sekarang.toLocaleDateString('id-ID');

  // Isi tanggal & waktu
  document.getElementById("tanggalHari").value = `${hari[sekarang.getDay()]}, ${hariIni}`;
  document.getElementById("waktu").value = sekarang.toTimeString().substring(0,8);

  // ---------- NOMOR ANTRIAN (reset tiap hari, aman offline) ----------
  let nomorAntrian = parseInt(localStorage.getItem("nomorAntrian") || "0");
  if (localStorage.getItem("hariTerakhir") !== hariIni) {
    localStorage.setItem("hariTerakhir", hariIni);
    localStorage.setItem("nomorAntrian", "0");
    nomorAntrian = 0;
  }
  const formatNomor = n => (n + 1).toString().padStart(3, "0");

  // Preview foto
  function previewFoto(input, previewId) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        document.getElementById(previewId).src = e.target.result;
        document.getElementById(previewId.replace("preview","foto") + "Base64").value = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  // Buka kamera langsung
  function bukaKamera(tipe) {
    const id = tipe === "ktp" ? "fileKtp" : tipe === "diri" ? "fileDiri" : "fileWajah";
    document.getElementById(id).click();
  }

  // Submit
  document.getElementById("tamuForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const btn = document.getElementById("main-submit");
    btn.disabled = true;
    btn.innerHTML = "Sedang mengirim...";
    document.querySelectorAll('input,textarea,button,select').forEach(el => el.disabled = true);

    const fd = new FormData();
    fd.append("nama", this.nama.value);
    fd.append("alamat", this.alamat.value);
    fd.append("instansi", this.instansi.value);
    fd.append("menemui", this.menemui.value);
    fd.append("urusan", this.urusan.value);
    fd.append("janji", this.janji.value);
    fd.append("keterangan", this.keterangan.value);
    fd.append("fotoKtp", document.getElementById("fotoKtpBase64").value);
    fd.append("fotoDiri", document.getElementById("fotoDiriBase64").value);
    fd.append("fotoWajah", document.getElementById("fotoWajahBase64").value);

    try {
      const res = await fetch(SCRIPT_URL, {method:"POST", body:fd});
      const json = await res.json();

      if (json.result === "success") {
        // Nomor naik HANYA kalau berhasil tersimpan
        nomorAntrian++;
        localStorage.setItem("nomorAntrian", nomorAntrian);

        document.getElementById("nomorAntrian").textContent = formatNomor(nomorAntrian);
        document.getElementById("tiketNama").textContent = this.nama.value;
        document.getElementById("tiketMenemui").textContent = this.menemui.value;
        document.getElementById("tiketWaktu").textContent = document.getElementById("waktu").value;
        document.getElementById("tiketTanggal").textContent = hariIni;
        document.getElementById("tiketAntrian").style.display = "flex";

        new Audio('https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3').play().catch(()=>{});
      } else {
        throw new Error(json.message || "Unknown error");
      }
    } catch (err) {
      alert("Gagal: " + err.message);
      btn.disabled = false;
      btn.innerHTML = "SUBMIT & CETAK NOMOR ANTRIAN";
      document.querySelectorAll('input,textarea,button,select').forEach(el => el.disabled = false);
    }
  });

  function tutupTiket() {
    document.getElementById("tiketAntrian").style.display = "none";
    setTimeout(() => location.reload(), 600);
  }
</script>
</body>

</html>


